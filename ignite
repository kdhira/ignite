#!/bin/bash
set -e
IGNITE_INSTALLATION=${IGNITE_INSTALLATION:-$(dirname $(readlink $(which $0) || echo $(which $0)))}
if [ ! -d "$IGNITE_INSTALLATION" ]; then
    echo '\033[31mfatal: ignite incorrectly configured' >&2
    echo '\033[31mfatal: $IGNITE_INSTALLATION variable does not reference an Ignite installation' >&2
    exit 1
fi
. $IGNITE_INSTALLATION/modules/import
_ignite_version=$(cat $IGNITE_INSTALLATION/VERSION)
################################################################################
# Behavoural
################################################################################

import_module log
import_module colors

function usage {
    if [[ "${#VALID_OPERATIONS[@]}" -eq 0 ]]; then
        echo "No operations defined in ignite script" >&2
        exit 1
    fi
    echo "Usage:"
    for op in "${VALID_OPERATIONS[@]}"; do
        echo -e "\t$0 $_ignite_script_name $op"
    done
}

function main {
    if [[ $# -eq 0 ]] || [ -z "$1" ]; then
        usage
        exit 1
    fi
    command="$1"
    shift

    # See if implementation-defined operation
    for op in "${VALID_OPERATIONS[@]}"; do
        op=(${op[@]})
        if [[ "$command" == "${op[0]}" ]]; then
            if [ ! -d "$SOURCE_PATH" ]; then
                echo "$SOURCE_PATH does not exist" >&2
                exit 1
            fi
            cd $SOURCE_PATH
            echo -e "\033[1mExecuting $_ignite_script_name->$command\033[0m"
            op_$command "$@"
            exit $?
        fi
    done
    # Didnt hit a registered operation
    case "$command" in
        help)
            usage
            exit $?
            ;;
        *)
            echo "Unknown command '$command'"
            usage
            exit 1
            ;;
    esac
}


################################################################################
# Functional
################################################################################
echo -e "\033[1mIgnite $_ignite_version - Kevin Hira\033[0m"
echo $_ignite_version | grep -E -e '^v\d+\.\d+\.\d+$' &> /dev/null || echo -e "\033[33mDevelopment build detected... Execution may be unstable\033[0m"

if [[ $# -eq 0 ]]; then
    echo "Usage: $0 {script} {command}" >&2
    exit 1
fi


_ignite_script_path=$(resolve_script $1) || {
    echo "Could not resolve script \"$1\""
    exit 2
}
_ignite_script_name="$1"
shift

. "$_ignite_script_path"

VALID_OPERATIONS=${VALID_OPERATIONS:-()}
SOURCE_PATH=${SOURCE_PATH:-"."}

# Execute main function
main "$@"
