#!/bin/bash
set -e

IGNITE_INSTALLATION=${IGNITE_INSTALLATION:-$(dirname $(readlink $(which $0) || echo $(which $0)))}
if [ ! -d "$IGNITE_INSTALLATION" ]; then
    echo -e '\033[31mfatal: Ignite incorrectly configured\033[0m' >&2
    echo -e '\033[31mfatal: $IGNITE_INSTALLATION variable does not reference an Ignite installation\033[0m' >&2
    exit 1
fi

. $IGNITE_INSTALLATION/modules/import
import_module commands
_ignite_version=$(cat $IGNITE_INSTALLATION/VERSION)

function script_usage {
    echo "Usage:"
    for op in `_commands_get`; do
        echo -e "   $(basename $0) $_ignite_script_name $op"
    done
}

echo -e "\033[1mIgnite $_ignite_version - Kevin Hira ($(date "+%b %Y"))\033[0m"
echo $_ignite_version | grep -E -e '^v\d+\.\d+\.\d+$' &> /dev/null || echo -e "\033[33mDevelopment build detected... Execution may be unstable\033[0m"

special_switches=(
    "--available which_scripts"
    "--whereis resolve_script \$2"
    "--help ignite_usage"
)

function ignite_usage {
    echo "Usage:"
    echo "    $(basename $0) <script_name> <command> [command-arguments..]"
    echo "    $(basename $0) --available"
    echo "    $(basename $0) --whereis <script_name>"
    echo "    $(basename $0) --help"

}

if [[ $# -eq 0 ]]; then
    ignite_usage >&2
    exit 1
fi


for switch in "${special_switches[@]}"; do
    switch=($switch)
    if [[ "$1" == "${switch[0]}" ]]; then
        eval ${switch[@]:1}
        exit $?
    fi
done

_ignite_script_path=$(resolve_script $1) || {
    echo "Could not resolve script \"$1\""
    exit 2
}
_ignite_script_name="$1"
shift

. "$_ignite_script_path"

if [[ $# -eq 0 ]] || [ -z "$1" ]; then
    script_usage
    exit 1
fi
_ignite_command="$1"
shift


for op in `_commands_get`; do
    if [[ "$_ignite_command" == "$op" ]]; then
        echo -e "\033[1mExecuting $_ignite_script_name->$_ignite_command\033[0m"
        op_$_ignite_command "$@"
        exit $?
    fi
done
case "$_ignite_command" in
    --help)
        script_usage
        exit 0
        ;;
    *)
        echo "Unknown command '$_ignite_command'"
        script_usage
        exit 128
        ;;
esac
